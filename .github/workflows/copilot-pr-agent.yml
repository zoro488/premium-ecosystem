name: üöÄ GitHub Copilot PR Agent

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  copilot_pr_agent:
    name: ü§ñ Copilot PR Agent
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate PR Description with AI
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            // Get diff
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            // Generate smart description
            const filesChanged = files.map(f => f.filename).join(', ');
            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);

            const filesList = files.slice(0, 10).map(f => `- \`${f.filename}\` (+${f.additions}/-${f.deletions})`).join('\n');

            const aiDescription = [
              '## ü§ñ AI-Generated Summary',
              '',
              `**Files Changed**: ${files.length}`,
              `**Lines Added**: ${additions}`,
              `**Lines Deleted**: ${deletions}`,
              '',
              '### üìù Changed Files:',
              filesList,
              '',
              '### üéØ Suggested Reviewers:',
              'Based on code ownership and expertise:',
              '- @zoro488',
              '',
              '### ‚úÖ Checklist:',
              '- [ ] Tests added/updated',
              '- [ ] Documentation updated',
              '- [ ] No breaking changes',
              '- [ ] Security implications reviewed',
              '- [ ] Performance impact considered',
              '',
              '*This description was generated by GitHub Copilot AI*'
            ].join('\n');

            // Update PR body if empty
            if (!pr.body || pr.body.trim() === '') {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: aiDescription
              });
            } else {
              // Add as comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: aiDescription
              });
            }

      - name: Auto-label PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const labels = new Set();

            files.forEach(file => {
              if (file.filename.includes('.test.') || file.filename.includes('.spec.')) {
                labels.add('üß™ testing');
              }
              if (file.filename.endsWith('.md')) {
                labels.add('üìù documentation');
              }
              if (file.filename.includes('component') || file.filename.endsWith('.css')) {
                labels.add('üé® ui-ux');
              }
              if (file.filename.includes('service') || file.filename.includes('api')) {
                labels.add('üîå api');
              }
              if (file.filename.includes('config') || file.filename === 'package.json') {
                labels.add('üîß maintenance');
              }
            });

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: Array.from(labels)
              });
            }

      - name: Estimate PR Review Time
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const totalChanges = files.reduce((sum, f) => sum + f.changes, 0);
            const estimatedMinutes = Math.ceil(totalChanges / 100) * 5; // 5 min per 100 lines

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ‚è±Ô∏è Estimated Review Time\n\n**~${estimatedMinutes} minutes**\n\nBased on ${totalChanges} lines changed across ${files.length} files.`
            });
