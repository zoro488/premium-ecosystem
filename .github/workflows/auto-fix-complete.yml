name: ğŸ¤– Auto-Fix Complete System

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      fix_type:
        description: 'Type of fixes to apply'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - lint
          - format
          - security
          - dependencies

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run ESLint Auto-Fix
        if: github.event.inputs.fix_type == 'all' || github.event.inputs.fix_type == 'lint' || github.event_name == 'schedule'
        run: |
          npm run lint:fix || true
          echo "âœ… ESLint auto-fix completed"

      - name: ğŸ’… Run Prettier Format
        if: github.event.inputs.fix_type == 'all' || github.event.inputs.fix_type == 'format' || github.event_name == 'schedule'
        run: |
          npm run format || true
          echo "âœ… Prettier formatting completed"

      - name: ğŸ”’ Run Security Audit Fix
        if: github.event.inputs.fix_type == 'all' || github.event.inputs.fix_type == 'security' || github.event_name == 'schedule'
        run: |
          npm audit fix --force || true
          echo "âœ… Security audit fix completed"

      - name: ğŸ“ˆ Update Dependencies
        if: github.event.inputs.fix_type == 'all' || github.event.inputs.fix_type == 'dependencies' || github.event_name == 'schedule'
        run: |
          npm update || true
          echo "âœ… Dependencies updated"

      - name: ğŸ§ª Run Tests
        run: |
          npm test -- --run || true
          echo "âœ… Tests executed"

      - name: ğŸ“Š Generate Fix Report
        run: |
          echo "# ğŸ¤– Auto-Fix Report" > fix-report.md
          echo "" >> fix-report.md
          echo "## Changes Applied" >> fix-report.md
          echo "- ESLint auto-fix" >> fix-report.md
          echo "- Prettier formatting" >> fix-report.md
          echo "- Security patches" >> fix-report.md
          echo "- Dependency updates" >> fix-report.md
          echo "" >> fix-report.md
          echo "Generated: $(date)" >> fix-report.md

      - name: ğŸ“ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ğŸ¤– chore: auto-fix linting, formatting, and security'
          title: 'ğŸ¤– Auto-fix: Linting, Formatting, Security & Dependencies'
          body: |
            ## ğŸ¤– Automated Fixes Applied

            This PR contains automated fixes generated by the Auto-Fix workflow:

            ### âœ… Changes
            - ğŸ” ESLint auto-fix applied
            - ğŸ’… Prettier formatting applied
            - ğŸ”’ Security vulnerabilities patched
            - ğŸ“¦ Dependencies updated to latest compatible versions

            ### ğŸ§ª Tests
            - All tests have been executed
            - Review test results in workflow logs

            ### ğŸ“‹ Checklist
            - [ ] Review all changes
            - [ ] Verify tests pass
            - [ ] Check for breaking changes
            - [ ] Merge when ready

            ---
            *Auto-generated by GitHub Actions*
            *Workflow: `auto-fix-complete.yml`*
          branch: auto-fix/automated-fixes-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            maintenance
            dependencies

      - name: ğŸ“¢ Notify on Discord (Optional)
        if: failure()
        run: |
          echo "âš ï¸ Auto-fix workflow failed"
          echo "Manual intervention may be required"
