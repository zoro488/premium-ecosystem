name: üõ†Ô∏è Auto-Correcci√≥n Inteligente

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'  # Cada 4 horas
  push:
    branches: [main]

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write

    strategy:
      matrix:
        retry: [1, 2, 3, 4, 5]
      fail-fast: false

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì¶ Instalar dependencias
        run: npm ci || npm install --ignore-scripts

      - name: üß™ Ejecutar tests (Intento ${{ matrix.retry }})
        id: test
        run: |
          npm test -- --run 2>&1 | tee test-output.log
        continue-on-error: true

      - name: üîç Analizar tipo de error
        if: steps.test.outcome == 'failure'
        run: |
          echo "‚ùå Tests fallaron en intento ${{ matrix.retry }}"

          if grep -qi "ECONNREFUSED\|ETIMEDOUT\|ENOTFOUND" test-output.log; then
            echo "ERROR_TYPE=connection" >> $GITHUB_ENV
            echo "üîå Error de CONEXI√ìN detectado"
          elif grep -qi "TypeError\|ReferenceError\|SyntaxError" test-output.log; then
            echo "ERROR_TYPE=types" >> $GITHUB_ENV
            echo "üìù Error de TIPOS detectado"
          elif grep -qi "TIMEOUT\|timeout" test-output.log; then
            echo "ERROR_TYPE=timeout" >> $GITHUB_ENV
            echo "‚è±Ô∏è Error de TIMEOUT detectado"
          else
            echo "ERROR_TYPE=unknown" >> $GITHUB_ENV
            echo "‚ùì Error DESCONOCIDO detectado"
          fi

      - name: üõ†Ô∏è Correcci√≥n - Reconectar servicios
        if: env.ERROR_TYPE == 'connection' && matrix.retry < 5
        run: |
          echo "üîß Aplicando correcci√≥n: Reconectar servicios..."
          pkill -f firebase || true
          pkill -f node || true
          sleep 5

          # Reiniciar Firebase Emulator si existe
          if command -v firebase &> /dev/null; then
            firebase emulators:start --only firestore &
            sleep 20
          fi

      - name: üõ†Ô∏è Correcci√≥n - Actualizar tipos
        if: env.ERROR_TYPE == 'types' && matrix.retry < 5
        run: |
          echo "üîß Aplicando correcci√≥n: Actualizar dependencias de tipos..."
          npm install -D @types/node@latest @types/react@latest --no-save
          npm install --force --ignore-scripts

      - name: üõ†Ô∏è Correcci√≥n - Aumentar timeouts
        if: env.ERROR_TYPE == 'timeout' && matrix.retry < 5
        run: |
          echo "üîß Aplicando correcci√≥n: Aumentar timeouts..."

          # Actualizar timeout en vitest.config.js
          if [ -f "vitest.config.js" ]; then
            sed -i 's/testTimeout: [0-9]*/testTimeout: 30000/g' vitest.config.js
          fi

      - name: üõ†Ô∏è Correcci√≥n - Limpiar y reinstalar
        if: env.ERROR_TYPE == 'unknown' && matrix.retry < 5
        run: |
          echo "üîß Aplicando correcci√≥n: Limpieza completa..."
          npm cache clean --force
          rm -rf node_modules package-lock.json
          npm install --ignore-scripts

      - name: üîÑ Re-ejecutar tests despu√©s de correcci√≥n
        if: steps.test.outcome == 'failure' && matrix.retry < 5
        id: retest
        run: npm test -- --run
        continue-on-error: true

      - name: ‚úÖ Tests exitosos despu√©s de correcci√≥n
        if: steps.retest.outcome == 'success' && matrix.retry > 1
        run: |
          echo "‚úÖ Tests pasaron despu√©s de ${{ matrix.retry }} intentos"
          echo "TESTS_FIXED=true" >> $GITHUB_ENV
          echo "RETRY_COUNT=${{ matrix.retry }}" >> $GITHUB_ENV

      - name: üìä Generar reporte de correcci√≥n
        if: env.TESTS_FIXED == 'true'
        run: |
          cat > AUTO_FIX_REPORT.md << 'EOF'
          # üõ†Ô∏è Reporte de Auto-Correcci√≥n

          **Fecha**: $(date)
          **Intentos necesarios**: ${{ matrix.retry }}
          **Tipo de error**: ${{ env.ERROR_TYPE }}

          ## Resultado

          ‚úÖ Tests corregidos exitosamente despu√©s de ${{ matrix.retry }} intentos.

          ## Correcci√≥n aplicada

          - Tipo de error: **${{ env.ERROR_TYPE }}**
          - Acci√≥n tomada: Correcci√≥n espec√≠fica aplicada
          - Estado final: **Tests pasando ‚úÖ**

          ## Pr√≥ximos pasos

          Revisar y hacer merge de este PR para aplicar las correcciones.
          EOF

      - name: üìù Commit cambios
        if: env.TESTS_FIXED == 'true'
        run: |
          git config user.name "GitHub Actions Auto-Fix"
          git config user.email "actions@github.com"
          git add .
          git diff --staged --quiet || git commit -m "üõ†Ô∏è Auto-correcci√≥n aplicada (intento ${{ matrix.retry }})"

      - name: üéâ Crear PR con correcci√≥n
        if: env.TESTS_FIXED == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto-fix-${{ github.run_number }}-retry-${{ matrix.retry }}
          title: "üõ†Ô∏è Auto-correcci√≥n aplicada (intento ${{ matrix.retry }}/5)"
          body: |
            ## üõ†Ô∏è Auto-Correcci√≥n Exitosa

            ### üìä Resumen

            - **Intentos necesarios**: ${{ matrix.retry }} de 5
            - **Tipo de error**: ${{ env.ERROR_TYPE }}
            - **Estado**: ‚úÖ Tests pasando

            ### üîß Correcci√≥n aplicada

            El sistema detect√≥ un error de tipo **${{ env.ERROR_TYPE }}** y aplic√≥
            la correcci√≥n espec√≠fica autom√°ticamente.

            ### ‚úÖ Resultado

            Todos los tests est√°n pasando correctamente despu√©s de la correcci√≥n.

            Ver reporte completo: [AUTO_FIX_REPORT.md](./AUTO_FIX_REPORT.md)

            ---

            ü§ñ Generado autom√°ticamente por el sistema de auto-correcci√≥n

      - name: ‚ùå Crear issue si todos los intentos fallaron
        if: steps.test.outcome == 'failure' && steps.retest.outcome == 'failure' && matrix.retry == 5
        run: |
          gh issue create \
            --title "üö® Auto-correcci√≥n fall√≥ despu√©s de 5 intentos" \
            --body "## üö® Error Cr√≠tico

          Los tests fallaron despu√©s de 5 intentos de auto-correcci√≥n.

          **Tipo de error**: ${{ env.ERROR_TYPE }}
          **√öltimo intento**: ${{ matrix.retry }}

          ### Acciones intentadas

          - Reconexi√≥n de servicios
          - Actualizaci√≥n de dependencias
          - Ajuste de timeouts
          - Limpieza de cache

          **Se requiere revisi√≥n manual.**

          Ver logs del workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --label "bug,auto-fix-failed,critical"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
