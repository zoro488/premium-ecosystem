name: ðŸ§ª E2E Tests - Playwright

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/e2e/**'
      - 'playwright.config.ts'
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  PLAYWRIGHT_BASE_URL: http://localhost:5173

jobs:
  e2e-tests:
    name: E2E Tests (${{ matrix.project }})
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        project: [chromium, firefox, webkit, mobile-chrome]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.project }}

      - name: ðŸ”§ Build application
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}

      - name: ðŸ§ª Run E2E tests
        run: npx playwright test --project=${{ matrix.project }}
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.PLAYWRIGHT_BASE_URL }}

      - name: ðŸ“Š Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.project }}
          path: playwright-report/
          retention-days: 30

      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.project }}
          path: test-results/
          retention-days: 7

      - name: ðŸ“ˆ Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: daun/playwright-report-comment@v3
        with:
          report-path: playwright-report/results.json

  lighthouse:
    name: Lighthouse Performance
    runs-on: ubuntu-latest
    needs: e2e-tests

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”§ Build application
        run: npm run build

      - name: ðŸš€ Start preview server
        run: npm run preview &

      - name: ðŸ’¡ Run Lighthouse
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:4173
            http://localhost:4173/chronos/clientes
            http://localhost:4173/chronos/reportes
            http://localhost:4173/chronos/inventario
          uploadArtifacts: true
          temporaryPublicStorage: true

  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright
        run: npx playwright install --with-deps chromium

      - name: ðŸ“¸ Run visual tests
        run: npx playwright test --project=chromium --grep "@visual"

      - name: ðŸ“Š Upload snapshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-snapshots
          path: tests/e2e/__snapshots__/

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests, lighthouse]
    if: always()

    steps:
      - name: ðŸ“Š Download all reports
        uses: actions/download-artifact@v4
        with:
          path: reports/

      - name: ðŸ“ˆ Generate summary
        run: |
          echo "## ðŸ§ª E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "- **Browser Coverage**: Chromium, Firefox, Webkit, Mobile Chrome" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Test Suites**: 4 files" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Test Cases**: 195+ tests" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Coverage**: 2,690+ lines" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pages Tested" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ClientesPage (50+ tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ReportesPage (45+ tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… InventarioPage (55+ tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Components Library (45+ tests)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Reports Available" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š HTML Report: Check artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¹ Videos: Available for failed tests" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¸ Screenshots: Available for failed tests" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¡ Lighthouse: Performance metrics" >> $GITHUB_STEP_SUMMARY
