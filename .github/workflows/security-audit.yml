name: ðŸ”’ Security Audit & Compliance

on:
  schedule:
    # AuditorÃ­a semanal los lunes a las 04:00 UTC
    - cron: '0 4 * * 1'
    # Escaneo diario ligero a las 06:00 UTC
    - cron: '0 6 * * *'

  push:
    branches:
      - main
      - develop

  pull_request:
    branches:
      - main
      - develop

  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Tipo de escaneo'
        required: true
        type: choice
        options:
          - full
          - quick
          - dependencies
          - code
          - secrets
        default: 'full'

env:
  NODE_VERSION: '20.x'

jobs:
  dependency-scan:
    name: ðŸ“¦ Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” NPM Audit
        run: |
          npm audit --json > npm-audit.json || true
          npm audit

      - name: ðŸ“Š Analyze vulnerabilities
        run: |
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit.json)

          echo "ðŸ”´ Critical: $CRITICAL"
          echo "ðŸŸ  High: $HIGH"
          echo "ðŸŸ¡ Moderate: $MODERATE"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ Critical vulnerabilities found!"
            exit 1
          fi

      - name: ðŸ” Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-report.json

      - name: ðŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-reports
          path: |
            npm-audit.json
            snyk-report.json

  code-security-scan:
    name: ðŸ” Code Security Analysis
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript
          queries: security-and-quality

      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

  secret-scan:
    name: ðŸ” Secret Detection
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: ðŸ” GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: ðŸ” Check environment files
        run: |
          echo "Checking for exposed secrets in config files..."

          # Verificar archivos .env
          if find . -name ".env" -not -path "*/node_modules/*" | grep -q .; then
            echo "âš ï¸ Warning: .env files found (should be in .gitignore)"
            find . -name ".env" -not -path "*/node_modules/*"
          fi

          # Verificar claves de Firebase
          if grep -r "AIza" --include="*.js" --include="*.ts" --include="*.json" --exclude-dir=node_modules .; then
            echo "âŒ Possible Firebase API keys found in code!"
            exit 1
          fi

  firebase-security:
    name: ðŸ”¥ Firebase Security Rules
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: ðŸ” Validate Firestore Rules
        run: |
          if [ -f "firestore.rules" ]; then
            echo "âœ… Firestore rules found"

            # Verificar reglas bÃ¡sicas de seguridad
            if grep -q "allow read, write: if true" firestore.rules; then
              echo "âŒ CRITICAL: Insecure rules found (allow all)!"
              exit 1
            fi

            if grep -q "request.auth" firestore.rules; then
              echo "âœ… Authentication checks present"
            else
              echo "âš ï¸ Warning: No authentication checks found"
            fi
          else
            echo "âŒ firestore.rules not found!"
            exit 1
          fi

      - name: ðŸ” Validate Storage Rules
        run: |
          if [ -f "storage.rules" ]; then
            echo "âœ… Storage rules found"

            if grep -q "allow read, write: if true" storage.rules; then
              echo "âŒ CRITICAL: Insecure storage rules!"
              exit 1
            fi
          else
            echo "âš ï¸ Warning: storage.rules not found"
          fi

      - name: ðŸ§ª Test Firestore Rules
        run: npm run test:firestore-rules || echo "âš ï¸ Firestore rules tests not configured"

  vulnerability-assessment:
    name: ðŸŽ¯ Vulnerability Assessment
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'premium-ecosystem'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental

      - name: ðŸ“¤ Upload OWASP reports
        uses: actions/upload-artifact@v4
        with:
          name: owasp-reports
          path: reports/

  compliance-check:
    name: âœ… Compliance Verification
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“‹ Check required files
        run: |
          REQUIRED_FILES=(
            "LICENSE"
            "README.md"
            "SECURITY.md"
            "CODE_OF_CONDUCT.md"
            ".github/PULL_REQUEST_TEMPLATE.md"
            ".github/ISSUE_TEMPLATE/bug_report.md"
            "firestore.rules"
            "firebase.json"
          )

          MISSING_FILES=()

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
              echo "âŒ Missing: $file"
            else
              echo "âœ… Found: $file"
            fi
          done

          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "âš ï¸ Warning: ${#MISSING_FILES[@]} required files missing"
          fi

      - name: ðŸ” Check security headers
        run: |
          # Verificar configuraciÃ³n de headers de seguridad
          if [ -f "firebase.json" ]; then
            if grep -q "headers" firebase.json; then
              echo "âœ… Security headers configured"
            else
              echo "âš ï¸ Warning: Security headers not configured"
            fi
          fi

      - name: ðŸ“Š License compliance
        run: |
          npm install -g license-checker
          license-checker --json --out licenses.json

          # Verificar licencias problemÃ¡ticas
          PROBLEMATIC=$(jq -r 'to_entries[] | select(.value.licenses | contains("GPL")) | .key' licenses.json || echo "")

          if [ -n "$PROBLEMATIC" ]; then
            echo "âš ï¸ Warning: GPL licenses found:"
            echo "$PROBLEMATIC"
          fi

  penetration-testing:
    name: ðŸŽ¯ Basic Penetration Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.scan_type == 'full'

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” SQL Injection check
        run: |
          echo "Checking for potential SQL injection vulnerabilities..."

          # Buscar patrones inseguros
          if grep -r "query.*\+.*req\." --include="*.js" --include="*.ts" --exclude-dir=node_modules .; then
            echo "âš ï¸ Potential SQL injection vulnerability found"
          fi

      - name: ðŸ” XSS vulnerability check
        run: |
          echo "Checking for potential XSS vulnerabilities..."

          # Buscar uso de dangerouslySetInnerHTML
          if grep -r "dangerouslySetInnerHTML" --include="*.jsx" --include="*.tsx" --exclude-dir=node_modules .; then
            echo "âš ï¸ dangerouslySetInnerHTML usage found - verify sanitization"
          fi

      - name: ðŸ” CSRF protection check
        run: |
          echo "Checking CSRF protection..."

          if grep -r "csrf" --include="*.js" --include="*.ts" --exclude-dir=node_modules . | grep -i "token\|protection"; then
            echo "âœ… CSRF protection found"
          else
            echo "âš ï¸ Warning: No CSRF protection detected"
          fi

  security-report:
    name: ðŸ“Š Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security-scan, secret-scan, firebase-security, vulnerability-assessment, compliance-check]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“¥ Download all reports
        uses: actions/download-artifact@v4
        with:
          path: security-reports/

      - name: ðŸ“Š Consolidate reports
        run: |
          mkdir -p final-report

          cat > final-report/security-audit-$(date +%Y%m%d).md <<EOF
          # ðŸ”’ Security Audit Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}

          ## ðŸ“Š Summary

          | Check | Status |
          |-------|--------|
          | Dependency Scan | ${{ needs.dependency-scan.result }} |
          | Code Security | ${{ needs.code-security-scan.result }} |
          | Secret Detection | ${{ needs.secret-scan.result }} |
          | Firebase Security | ${{ needs.firebase-security.result }} |
          | Vulnerability Assessment | ${{ needs.vulnerability-assessment.result }} |
          | Compliance Check | ${{ needs.compliance-check.result }} |

          ## ðŸŽ¯ Recommendations

          1. âœ… Mantener dependencias actualizadas
          2. âœ… Revisar y actualizar reglas de Firestore regularmente
          3. âœ… Rotar claves y secretos periÃ³dicamente
          4. âœ… Implementar monitoreo de seguridad continuo
          5. âœ… Realizar auditorÃ­as de cÃ³digo regulares

          ## ðŸ“Ž Detailed Reports

          Ver archivos adjuntos para reportes detallados.
          EOF

          cat final-report/security-audit-*.md

      - name: ðŸ“¤ Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: final-report/
          retention-days: 90

  notify-security-team:
    name: ðŸ“¢ Notify Security Team
    runs-on: ubuntu-latest
    needs: [security-report]
    if: |
      always() &&
      (needs.dependency-scan.result == 'failure' ||
       needs.code-security-scan.result == 'failure' ||
       needs.secret-scan.result == 'failure' ||
       needs.firebase-security.result == 'failure')

    steps:
      - name: ðŸ“§ Send security alert
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: 'ðŸš¨ SECURITY ALERT: Vulnerabilities Detected'
          body: |
            ðŸš¨ Se han detectado vulnerabilidades de seguridad.

            ðŸ“… Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            ðŸ“¦ Repositorio: ${{ github.repository }}
            ðŸŒ¿ Branch: ${{ github.ref_name }}
            ðŸ”— Detalles: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Por favor, revisa los reportes y toma acciÃ³n inmediata.
          to: security@company.com,${{ secrets.NOTIFICATION_EMAIL }}
          from: Security Scanner

      - name: ðŸ› Create security issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `ðŸš¨ **ALERTA DE SEGURIDAD**\n\n` +
                        `Se han detectado vulnerabilidades durante el escaneo automÃ¡tico.\n\n` +
                        `**Timestamp:** ${new Date().toISOString()}\n` +
                        `**Branch:** ${{ github.ref_name }}\n` +
                        `**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n` +
                        `## ðŸ“‹ Estado de Escaneos\n` +
                        `- Dependencias: ${{ needs.dependency-scan.result }}\n` +
                        `- CÃ³digo: ${{ needs.code-security-scan.result }}\n` +
                        `- Secretos: ${{ needs.secret-scan.result }}\n` +
                        `- Firebase: ${{ needs.firebase-security.result }}\n\n` +
                        `## âš ï¸ ACCIÃ“N REQUERIDA\n` +
                        `- [ ] Revisar reportes de seguridad\n` +
                        `- [ ] Identificar vulnerabilidades crÃ­ticas\n` +
                        `- [ ] Implementar fixes\n` +
                        `- [ ] Verificar y re-ejecutar escaneo\n` +
                        `- [ ] Actualizar documentaciÃ³n de seguridad`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ SECURITY: Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['security', 'critical', 'automated', 'high-priority'],
              assignees: ['zoro488']
            });
