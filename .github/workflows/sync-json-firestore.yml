name: ðŸ”„ Sync JSON to Firestore

on:
    push:
        paths:
            - "data/bancos.json"
            - "data/*.json"
    workflow_dispatch:
        inputs:
            force:
                description: "Forzar sincronizaciÃ³n completa"
                required: false
                default: "false"

jobs:
    sync:
        name: Sincronizar JSON â†’ Firestore
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: ðŸ“¥ Install dependencies
              run: npm ci

            - name: ðŸ”„ Sync bancos.json â†’ Firestore
              run: node scripts/sync-json-to-firestore.js
              env:
                  FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
                  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
                  FORCE_SYNC: ${{ github.event.inputs.force }}

            - name: âœ… Verificar sincronizaciÃ³n
              run: node scripts/verificar-firestore-completo.js

            - name: ðŸ“Š Sync summary
              if: always()
              run: |
                  echo "### ðŸ”„ SincronizaciÃ³n completada" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Archivo:** data/bancos.json" >> $GITHUB_STEP_SUMMARY
                  echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
                  echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

            - name: ðŸ“¤ Commit verification results
              if: success()
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git add FIRESTORE_ESTADO_ACTUAL.json
                  git commit -m "chore: update Firestore verification [skip ci]" || echo "No changes"
                  git push origin ${{ github.ref_name }} || echo "Nothing to push"
