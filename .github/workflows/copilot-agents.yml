name: ðŸ¤– GitHub Copilot Agents

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write

jobs:
  # ============================================================================
  # COPILOT CODE REVIEW AGENT
  # ============================================================================
  copilot_review:
    name: ðŸ” Copilot Code Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with Copilot suggestions
        run: |
          npm run lint -- --format json > eslint-report.json || true

      - name: Copilot AI Review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const eslintReport = JSON.parse(fs.readFileSync('eslint-report.json', 'utf8'));

            let issues = [];
            eslintReport.forEach(file => {
              if (file.errorCount > 0 || file.warningCount > 0) {
                issues.push(`**${file.filePath}**\n- Errors: ${file.errorCount}\n- Warnings: ${file.warningCount}`);
              }
            });

            if (issues.length > 0 && context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `## ðŸ¤– Copilot Code Review\n\n${issues.join('\n\n')}\n\n*Powered by GitHub Copilot AI*`
              });
            }

  # ============================================================================
  # COPILOT TEST GENERATION AGENT
  # ============================================================================
  copilot_test_gen:
    name: ðŸ§ª Auto Generate Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Detect files without tests
        id: detect
        run: |
          # Find source files without corresponding test files
          find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | while read file; do
            testFile="${file%.tsx}.test.tsx"
            testFile="${testFile%.ts}.test.ts"
            testFile="${testFile%.jsx}.test.jsx"
            testFile="${testFile%.js}.test.js"
            if [ ! -f "$testFile" ]; then
              echo "Missing test: $file"
            fi
          done > missing-tests.txt

      - name: Comment missing tests
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const missing = fs.readFileSync('missing-tests.txt', 'utf8');

            if (missing.trim()) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `## ðŸ§ª Copilot Test Suggestion\n\nThe following files are missing tests:\n\n\`\`\`\n${missing}\`\`\`\n\n*Use Copilot to generate tests with: "Generate tests for this file"*`
              });
            }

  # ============================================================================
  # COPILOT DOCUMENTATION AGENT
  # ============================================================================
  copilot_docs:
    name: ðŸ“ Auto Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check documentation coverage
        run: |
          # Check for JSDoc comments
          echo "Checking documentation coverage..."
          find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | xargs grep -L "@param\|@returns\|@description" > undocumented.txt || true

      - name: Generate documentation report
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('undocumented.txt')) {
              const undocumented = fs.readFileSync('undocumented.txt', 'utf8');
              if (undocumented.trim()) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: `## ðŸ“ Documentation Needed\n\nSome files could benefit from better documentation:\n\n\`\`\`\n${undocumented}\`\`\`\n\n*Use Copilot to generate JSDoc: "Add documentation for this function"*`
                });
              }
            }

  # ============================================================================
  # COPILOT SECURITY AGENT
  # ============================================================================
  copilot_security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: |
          npm audit --json > audit-report.json || true

      - name: Check for vulnerabilities
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const audit = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));

            if (audit.metadata && audit.metadata.vulnerabilities) {
              const vulns = audit.metadata.vulnerabilities;
              const total = vulns.critical + vulns.high + vulns.moderate + vulns.low;

              if (total > 0 && context.payload.pull_request) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: `## ðŸ”’ Security Vulnerabilities Detected\n\n- Critical: ${vulns.critical}\n- High: ${vulns.high}\n- Moderate: ${vulns.moderate}\n- Low: ${vulns.low}\n\nRun \`npm audit fix\` to resolve automatically.`
                });
              }
            }

  # ============================================================================
  # COPILOT PERFORMANCE AGENT
  # ============================================================================
  copilot_performance:
    name: âš¡ Performance Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build and analyze
        run: |
          npm run build
          du -sh dist/* | sort -rh | head -10 > bundle-sizes.txt

      - name: Report bundle sizes
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const sizes = fs.readFileSync('bundle-sizes.txt', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## âš¡ Bundle Size Analysis\n\n\`\`\`\n${sizes}\`\`\`\n\n*Tip: Use dynamic imports and code splitting to reduce bundle size*`
            });
