name: ğŸ”„ Sync Excel â†” Firestore

on:
  workflow_dispatch:
    inputs:
      sync_direction:
        description: 'DirecciÃ³n de sincronizaciÃ³n'
        required: true
        type: choice
        options:
          - excel_to_firestore
          - firestore_to_excel
          - bidirectional
        default: 'excel_to_firestore'
      force_sync:
        description: 'Forzar sincronizaciÃ³n completa'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Modo simulaciÃ³n (no aplicar cambios)'
        required: false
        type: boolean
        default: false

  schedule:
    # SincronizaciÃ³n diaria a medianoche (horario UTC)
    - cron: '0 0 * * *'
    # SincronizaciÃ³n de respaldo a las 12:00 UTC
    - cron: '0 12 * * *'

env:
  NODE_VERSION: '20.x'
  EXCEL_PATH: 'data/source'
  REPORTS_PATH: 'reports/sync'

jobs:
  prepare:
    name: ğŸ”§ Preparar SincronizaciÃ³n
    runs-on: ubuntu-latest
    outputs:
      sync_id: ${{ steps.generate.outputs.sync_id }}
      timestamp: ${{ steps.generate.outputs.timestamp }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Generate sync ID
        id: generate
        run: |
          SYNC_ID="sync_$(date +%Y%m%d_%H%M%S)_${{ github.run_number }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "sync_id=$SYNC_ID" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "ğŸ”‘ Sync ID: $SYNC_ID"

  validate-excel:
    name: âœ… Validar Archivos Excel
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: ğŸ” Validar estructura Excel
        run: |
          npm run validate:excel -- --path="${{ env.EXCEL_PATH }}" --strict

      - name: ğŸ“Š Generar estadÃ­sticas
        run: |
          npm run excel:stats -- --output="reports/excel-stats.json"

      - name: ğŸ“¤ Upload Excel stats
        uses: actions/upload-artifact@v4
        with:
          name: excel-stats
          path: reports/excel-stats.json

  sync-excel-to-firestore:
    name: ğŸ“¤ Excel â†’ Firestore
    runs-on: ubuntu-latest
    needs: [prepare, validate-excel]
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.sync_direction == 'excel_to_firestore' ||
        github.event.inputs.sync_direction == 'bidirectional'))

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: ğŸ” Setup Firebase credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=firebase-credentials.json" >> $GITHUB_ENV

      - name: ğŸ“¤ Import Excel to Firestore
        id: import
        run: |
          FLAGS=""
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            FLAGS="$FLAGS --dry-run"
          fi
          if [[ "${{ github.event.inputs.force_sync }}" == "true" ]]; then
            FLAGS="$FLAGS --force"
          fi

          npm run import:excel -- \
            --sync-id="${{ needs.prepare.outputs.sync_id }}" \
            --timestamp="${{ needs.prepare.outputs.timestamp }}" \
            $FLAGS | tee import.log

          # Extraer mÃ©tricas
          RECORDS_IMPORTED=$(grep -oP 'Imported: \K\d+' import.log || echo "0")
          RECORDS_UPDATED=$(grep -oP 'Updated: \K\d+' import.log || echo "0")
          RECORDS_FAILED=$(grep -oP 'Failed: \K\d+' import.log || echo "0")

          echo "records_imported=$RECORDS_IMPORTED" >> $GITHUB_OUTPUT
          echo "records_updated=$RECORDS_UPDATED" >> $GITHUB_OUTPUT
          echo "records_failed=$RECORDS_FAILED" >> $GITHUB_OUTPUT

      - name: âœ… Validar sincronizaciÃ³n
        run: npm run validate:sync -- --sync-id="${{ needs.prepare.outputs.sync_id }}"

      - name: ğŸ“Š Generar reporte
        run: |
          mkdir -p ${{ env.REPORTS_PATH }}
          npm run report:sync -- \
            --sync-id="${{ needs.prepare.outputs.sync_id }}" \
            --output="${{ env.REPORTS_PATH }}/import-report.json"

      - name: ğŸ“¤ Upload import report
        uses: actions/upload-artifact@v4
        with:
          name: import-report
          path: ${{ env.REPORTS_PATH }}/import-report.json

  sync-firestore-to-excel:
    name: ğŸ“¥ Firestore â†’ Excel
    runs-on: ubuntu-latest
    needs: [prepare, validate-excel]
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.sync_direction == 'firestore_to_excel' ||
       github.event.inputs.sync_direction == 'bidirectional')

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: ğŸ” Setup Firebase credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=firebase-credentials.json" >> $GITHUB_ENV

      - name: ğŸ“¥ Export Firestore to Excel
        run: |
          FLAGS=""
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            FLAGS="$FLAGS --dry-run"
          fi

          npm run export:excel -- \
            --sync-id="${{ needs.prepare.outputs.sync_id }}" \
            --timestamp="${{ needs.prepare.outputs.timestamp }}" \
            $FLAGS

      - name: ğŸ“¤ Upload exported Excel
        if: github.event.inputs.dry_run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: exported-excel-${{ needs.prepare.outputs.sync_id }}
          path: ${{ env.EXCEL_PATH }}/export_*.xlsx
          retention-days: 30

  commit-reports:
    name: ğŸ’¾ Commit Reportes
    runs-on: ubuntu-latest
    needs: [prepare, sync-excel-to-firestore]
    if: |
      always() &&
      needs.sync-excel-to-firestore.result == 'success' &&
      github.event.inputs.dry_run != 'true'

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ Download reports
        uses: actions/download-artifact@v4
        with:
          name: import-report
          path: ${{ env.REPORTS_PATH }}

      - name: ğŸ’¾ Commit y push reportes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add reports/

          if git diff --staged --quiet; then
            echo "No hay cambios en reportes"
          else
            git commit -m "ğŸ“Š Sync report ${{ needs.prepare.outputs.sync_id }} - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi

  notify-success:
    name: âœ… Notificar Ã‰xito
    runs-on: ubuntu-latest
    needs: [prepare, sync-excel-to-firestore, commit-reports]
    if: |
      always() &&
      needs.sync-excel-to-firestore.result == 'success'

    steps:
      - name: ğŸ“Š Resumen de sincronizaciÃ³n
        run: |
          echo "âœ… SincronizaciÃ³n completada exitosamente"
          echo "ğŸ”‘ Sync ID: ${{ needs.prepare.outputs.sync_id }}"
          echo "ğŸ“¤ Registros importados: ${{ needs.sync-excel-to-firestore.outputs.records_imported }}"
          echo "ğŸ”„ Registros actualizados: ${{ needs.sync-excel-to-firestore.outputs.records_updated }}"
          echo "âŒ Registros fallidos: ${{ needs.sync-excel-to-firestore.outputs.records_failed }}"

      - name: ğŸ’¬ Create issue comment (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **SincronizaciÃ³n Excel â†” Firestore Completada**\n\n` +
                    `ğŸ”‘ Sync ID: \`${{ needs.prepare.outputs.sync_id }}\`\n` +
                    `ğŸ“¤ Importados: ${{ needs.sync-excel-to-firestore.outputs.records_imported }}\n` +
                    `ğŸ”„ Actualizados: ${{ needs.sync-excel-to-firestore.outputs.records_updated }}\n` +
                    `âŒ Fallidos: ${{ needs.sync-excel-to-firestore.outputs.records_failed }}`
            });

  notify-failure:
    name: ğŸš¨ Notificar Fallo
    runs-on: ubuntu-latest
    needs: [prepare, sync-excel-to-firestore]
    if: |
      always() &&
      needs.sync-excel-to-firestore.result == 'failure'

    steps:
      - name: ğŸ“§ Send failure email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: 'ğŸš¨ SincronizaciÃ³n Excel-Firestore FallÃ³'
          body: |
            âŒ La sincronizaciÃ³n programada ha fallado.

            ğŸ”‘ Sync ID: ${{ needs.prepare.outputs.sync_id }}
            ğŸ“… Timestamp: ${{ needs.prepare.outputs.timestamp }}
            ğŸ”— Detalles: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Por favor, revisa los logs para mÃ¡s informaciÃ³n.
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions

      - name: ğŸ› Create issue on failure
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ SincronizaciÃ³n AutomÃ¡tica FallÃ³ - ${{ needs.prepare.outputs.sync_id }}`,
              body: `La sincronizaciÃ³n programada ha fallado.\n\n` +
                    `**Sync ID:** \`${{ needs.prepare.outputs.sync_id }}\`\n` +
                    `**Timestamp:** ${{ needs.prepare.outputs.timestamp }}\n` +
                    `**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n` +
                    `Por favor, investiga y resuelve el problema.`,
              labels: ['bug', 'automated-sync', 'high-priority']
            });
