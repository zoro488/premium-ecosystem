name: âœ… ValidaciÃ³n E2E AutÃ³noma

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Habilitar modo debug'
        required: false
        default: 'false'
  push:
    branches: [main]
    paths:
      - 'src/services/quantumExcelImporter.js'
      - 'src/services/firebaseService.js'
      - 'src/__tests__/e2e/**'
      - 'AdministaciÃ³n_General.xlsx'
  schedule:
    - cron: '0 */6 * * *' # Cada 6 horas

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ”§ Instalar dependencias
        run: npm ci --ignore-scripts

      - name: ðŸ”¥ Instalar Firebase Tools
        run: npm install -g firebase-tools

      - name: ðŸš€ Iniciar Firebase Emulator
        run: |
          firebase emulators:start --only firestore --project demo-test &
          echo "â³ Esperando a que el emulador estÃ© listo..."
          sleep 15
          echo "âœ… Firebase Emulator iniciado"
        env:
          FIREBASE_EMULATOR_HUB: localhost:4400

      - name: âœ… Ejecutar validaciÃ³n E2E
        run: npm run test:e2e:validation
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_FIREBASE_API_KEY: demo-api-key
          VITE_FIREBASE_AUTH_DOMAIN: demo.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: demo-test
          VITE_FIREBASE_STORAGE_BUCKET: demo.appspot.com
          VITE_FIREBASE_MESSAGING_SENDER_ID: '123456789'
          VITE_FIREBASE_APP_ID: demo-app-id
          NODE_ENV: test

      - name: ðŸ“Š Generar reporte de validaciÃ³n
        if: success()
        run: |
          cat > VALIDATION_REPORT.md << 'EOF'
          # âœ… ValidaciÃ³n E2E Exitosa

          **Fecha**: $(date)
          **Workflow Run**: ${{ github.run_number }}
          **Branch**: ${{ github.ref_name }}

          ## Resultados

          - âœ… Datos del Excel importados correctamente
          - âœ… Datos en Firestore validados
          - âœ… Capital Total: Excel = Firestore
          - âœ… Todos los bancos presentes
          - âœ… Transacciones validadas
          - âœ… Relaciones Ã­ntegras

          ## ConclusiÃ³n

          **Sistema validado correctamente. Datos consistentes en todas las capas.**

          ## Archivos Validados

          - `AdministaciÃ³n_General.xlsx` â†’ Firestore
          - Servicios: `quantumExcelImporter.js`, `firebaseService.js`
          - Tests E2E: `excel-firestore-ui-validation.test.js`

          ## MÃ©tricas

          - Timeout configurado: 90 segundos por test
          - Emulador Firestore: âœ… Funcionando
          - Cobertura E2E: âœ… Completa

          ---
          Generado automÃ¡ticamente por GitHub Actions
          EOF

      - name: ðŸ“¤ Subir reporte de validaciÃ³n
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report-${{ github.run_number }}
          path: VALIDATION_REPORT.md

      - name: ðŸ“¤ Subir resultados de tests
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            test-results-e2e/
            coverage-e2e/

      - name: ðŸŽ‰ Crear Pull Request con reporte
        if: success() && github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: validation-report-${{ github.run_number }}
          title: 'âœ… ValidaciÃ³n E2E completada exitosamente - Run #${{ github.run_number }}'
          body: |
            ## âœ… ValidaciÃ³n E2E Completada

            **EjecuciÃ³n automÃ¡tica del workflow de validaciÃ³n E2E**

            ### Resultados
            - âœ… Todos los tests E2E pasaron correctamente
            - âœ… Datos validados: Excel â†’ Firestore â†’ UI
            - âœ… Integridad de datos confirmada

            ### Detalles
            - **Workflow Run**: #${{ github.run_number }}
            - **Fecha**: $(date)
            - **Branch**: ${{ github.ref_name }}

            ### Archivos
            Ver reporte detallado: [VALIDATION_REPORT.md](./VALIDATION_REPORT.md)

            ### Artefactos
            - Reporte de validaciÃ³n
            - Resultados de tests E2E
            - Cobertura de cÃ³digo E2E

            ---
            Este PR fue creado automÃ¡ticamente por el workflow de validaciÃ³n E2E.
          commit-message: 'docs: agregar reporte de validaciÃ³n E2E run #${{ github.run_number }}'
          labels: |
            automated
            validation
            e2e
          assignees: ${{ github.actor }}

      - name: ðŸ§¹ Detener Firebase Emulator
        if: always()
        run: |
          pkill -f firebase || true
          echo "ðŸ›‘ Firebase Emulator detenido"

      - name: âŒ Reporte de fallo
        if: failure()
        run: |
          echo "âŒ La validaciÃ³n E2E fallÃ³"
          echo "Por favor revisa los logs y los artefactos subidos"
          cat > VALIDATION_FAILURE.md << 'EOF'
          # âŒ ValidaciÃ³n E2E Fallida

          **Fecha**: $(date)
          **Workflow Run**: ${{ github.run_number }}
          **Branch**: ${{ github.ref_name }}

          ## Error

          La validaciÃ³n E2E ha fallado. Por favor revisa los logs del workflow.

          ## Pasos para debuggear

          1. Revisa los logs del workflow
          2. Descarga los artefactos de test
          3. Ejecuta localmente: `npm run test:e2e:validation`
          4. Verifica que el archivo Excel existe y es vÃ¡lido
          5. Verifica la configuraciÃ³n de Firebase

          ---
          Generado automÃ¡ticamente por GitHub Actions
          EOF

      - name: ðŸ“¤ Subir reporte de fallo
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: validation-failure-${{ github.run_number }}
          path: VALIDATION_FAILURE.md
