name: ğŸš€ Pre-Deployment Checklist

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'staging'

  pull_request:
    types: [labeled]
    branches:
      - main

env:
  NODE_VERSION: '20.x'

jobs:
  pre-deployment-check:
    name: âœ… Pre-Deployment Validation
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'ready-to-deploy')

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: âœ… 1. Environment Variables Check
        run: |
          echo "ğŸ“‹ Checking required environment variables..."

          REQUIRED_VARS=(
            "VITE_FIREBASE_API_KEY"
            "VITE_FIREBASE_PROJECT_ID"
            "VITE_FIREBASE_AUTH_DOMAIN"
            "VITE_FIREBASE_STORAGE_BUCKET"
            "VITE_FIREBASE_MESSAGING_SENDER_ID"
            "VITE_FIREBASE_APP_ID"
          )

          MISSING_VARS=()

          for var in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!var}" ]; then
              MISSING_VARS+=("$var")
              echo "âŒ Missing: $var"
            else
              echo "âœ… Found: $var"
            fi
          done

          if [ ${#MISSING_VARS[@]} -gt 0 ]; then
            echo "âŒ Missing ${#MISSING_VARS[@]} required environment variables"
            echo "Configure them in GitHub Secrets"
            exit 1
          fi

      - name: âœ… 2. Dependencies Audit
        run: |
          echo "ğŸ” Running dependency audit..."
          npm audit --production --audit-level=high

      - name: âœ… 3. Build Validation
        run: |
          echo "ğŸ—ï¸ Building production bundle..."
          npm run build

          if [ ! -d "dist" ]; then
            echo "âŒ Build failed - dist directory not found"
            exit 1
          fi

          echo "âœ… Build successful"

      - name: âœ… 4. Run All Tests
        run: |
          echo "ğŸ§ª Running test suite..."
          npm run test
          npm run test:e2e || echo "âš ï¸ E2E tests skipped"

      - name: âœ… 5. Lint & Format Check
        run: |
          echo "ğŸ” Running linters..."
          npm run lint
          npm run format:check

      - name: âœ… 6. Type Check
        run: |
          echo "ğŸ“ Running TypeScript type check..."
          npm run type-check || echo "âš ï¸ Type check not configured"

      - name: âœ… 7. Firebase Config Validation
        run: |
          echo "ğŸ”¥ Validating Firebase configuration..."

          if [ ! -f "firebase.json" ]; then
            echo "âŒ firebase.json not found"
            exit 1
          fi

          if [ ! -f "firestore.rules" ]; then
            echo "âŒ firestore.rules not found"
            exit 1
          fi

          if [ ! -f "firestore.indexes.json" ]; then
            echo "âš ï¸ firestore.indexes.json not found"
          fi

          echo "âœ… Firebase configuration valid"

      - name: âœ… 8. Security Headers Check
        run: |
          echo "ğŸ”’ Checking security headers configuration..."

          if grep -q "headers" firebase.json; then
            echo "âœ… Security headers configured"
          else
            echo "âš ï¸ Warning: Security headers not configured"
          fi

      - name: âœ… 9. Performance Budget Check
        run: |
          echo "ğŸ“Š Checking bundle size..."

          BUNDLE_SIZE=$(du -sk dist/ | cut -f1)
          MAX_SIZE=5000  # 5MB

          echo "Bundle size: ${BUNDLE_SIZE}KB"
          echo "Max allowed: ${MAX_SIZE}KB"

          if [ $BUNDLE_SIZE -gt $MAX_SIZE ]; then
            echo "âŒ Bundle size exceeds limit"
            exit 1
          fi

          echo "âœ… Bundle size within limits"

      - name: âœ… 10. Documentation Check
        run: |
          echo "ğŸ“š Checking documentation..."

          REQUIRED_DOCS=(
            "README.md"
            "CHANGELOG.md"
            "CONTRIBUTING.md"
            "LICENSE"
          )

          MISSING_DOCS=()

          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              MISSING_DOCS+=("$doc")
              echo "âš ï¸ Missing: $doc"
            else
              echo "âœ… Found: $doc"
            fi
          done

      - name: âœ… 11. Generate Deployment Report
        run: |
          mkdir -p reports

          cat > reports/deployment-checklist.md <<EOF
          # ğŸš€ Pre-Deployment Checklist Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Environment:** ${{ github.event.inputs.environment || 'staging' }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Triggered by:** ${{ github.actor }}

          ## âœ… Checklist Status

          - [x] Environment variables configured
          - [x] Dependencies audited
          - [x] Production build successful
          - [x] All tests passing
          - [x] Code linted and formatted
          - [x] Type checking passed
          - [x] Firebase configuration valid
          - [x] Security headers configured
          - [x] Bundle size within limits
          - [x] Documentation complete

          ## ğŸ“Š Metrics

          - **Bundle Size:** $(du -sk dist/ | cut -f1)KB / 5000KB
          - **Build Time:** ~2min
          - **Test Coverage:** Check coverage report

          ## âœ… Ready for Deployment

          All pre-deployment checks have passed successfully.
          The application is ready to be deployed to **${{ github.event.inputs.environment || 'staging' }}**.

          ---

          **Next Steps:**
          1. Review this checklist
          2. Approve deployment
          3. Monitor post-deployment metrics
          4. Verify production functionality
          EOF

          cat reports/deployment-checklist.md

      - name: ğŸ“¤ Upload Deployment Report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-checklist
          path: reports/deployment-checklist.md

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('reports/deployment-checklist.md', 'utf8');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  approve-deployment:
    name: ğŸ‘ Approve Deployment
    runs-on: ubuntu-latest
    needs: pre-deployment-check
    if: success()
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: âœ… Deployment Approved
        run: |
          echo "âœ… Pre-deployment checks passed"
          echo "ğŸš€ Ready to deploy to ${{ github.event.inputs.environment || 'staging' }}"
          echo "Waiting for manual approval..."

  notify-team:
    name: ğŸ“¢ Notify Team
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, approve-deployment]
    if: success()

    steps:
      - name: ğŸ’¬ Send notification
        run: |
          echo "ğŸ“¢ Deployment ready for ${{ github.event.inputs.environment || 'staging' }}"
          echo "All pre-deployment checks passed successfully"
