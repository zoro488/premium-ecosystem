name: ‚úÖ Validaci√≥n E2E Aut√≥noma

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: false
        default: 'test'
  push:
    branches: [main]
    paths:
      - 'src/services/quantumExcelImporter.js'
      - 'src/services/firebaseService.js'
      - 'src/components/KPICard.jsx'
      - 'src/__tests__/e2e/**'
      - 'public/*.xlsx'
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci --ignore-scripts

      - name: üîç Check for Excel files
        id: check_excel
        run: |
          if [ -f "public/FlowDistributor_Data.xlsx" ] || [ -f "Administaci√≥n_General.xlsx" ]; then
            echo "excel_found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Excel files found"
          else
            echo "excel_found=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No Excel files found, tests will use mock data"
          fi

      - name: üß™ Run E2E validation tests
        id: e2e_tests
        run: |
          echo "üöÄ Starting E2E validation tests..."
          npm run test:e2e:run || echo "test_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true
        env:
          NODE_ENV: test
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}

      - name: üìä Generate validation report
        if: steps.e2e_tests.outputs.test_failed != 'true'
        run: |
          npm run generate:report
          echo "‚úÖ Validation report generated"

      - name: üì§ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            test-results/
            VALIDATION_REPORT.md
          retention-days: 30

      - name: üìù Create PR if validation successful
        if: steps.e2e_tests.outputs.test_failed != 'true' && github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "‚úÖ Validaci√≥n E2E completada - $(date +'%Y-%m-%d %H:%M')"
          title: "‚úÖ Validaci√≥n E2E completada - $(date +'%Y-%m-%d')"
          body: |
            ## ‚úÖ Validaci√≥n E2E Completada Exitosamente
            
            Este PR es generado autom√°ticamente despu√©s de una validaci√≥n E2E exitosa.
            
            ### üìä Resultados
            
            - ‚úÖ Datos del Excel validados en Firestore
            - ‚úÖ Componentes UI muestran datos correctos
            - ‚úÖ Integridad de datos verificada
            
            ### üìù Detalles
            
            Ver el archivo `VALIDATION_REPORT.md` para detalles completos.
            
            ### üîó Artifacts
            
            Los resultados de los tests est√°n disponibles en los artifacts de este workflow.
            
            ---
            *Generado autom√°ticamente por el workflow de validaci√≥n E2E*
          branch: validation/e2e-auto-${{ github.run_number }}
          delete-branch: true
          labels: |
            validation
            automated
            e2e

      - name: üí¨ Comment on PR if triggered by push
        if: steps.e2e_tests.outputs.test_failed != 'true' && github.event_name == 'push' && github.event.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Validaci√≥n E2E completada exitosamente**\n\nTodos los tests E2E pasaron correctamente. Los datos del Excel se reflejan correctamente en Firestore y en los componentes UI.'
            })

      - name: ‚ùå Report test failure
        if: steps.e2e_tests.outputs.test_failed == 'true'
        run: |
          echo "‚ùå E2E tests failed"
          echo "Please check the test results for details"
          exit 1

  # Notify on failure
  notify-failure:
    runs-on: ubuntu-latest
    needs: validate
    if: failure()
    
    permissions:
      contents: read
    
    steps:
      - name: üö® Notify failure
        run: |
          echo "‚ùå E2E Validation failed"
          echo "Check the workflow logs for details"
          echo "Notification system can be extended here"
