name: âœ… ValidaciÃ³n E2E AutÃ³noma

on:
  workflow_dispatch:
    inputs:
      skip_emulator:
        description: 'Skip Firebase emulator (use mocked data)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    branches: [main, develop]
    paths:
      - 'src/services/**'
      - 'src/components/**'
      - 'src/__tests__/e2e/**'
      - 'vitest.e2e.config.js'
  schedule:
    # Ejecutar cada 6 horas
    - cron: '0 */6 * * *'

# Permisos necesarios
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate:
    name: ðŸ”¥ Excel â†’ Firestore â†’ UI
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        run: npm ci --legacy-peer-deps --ignore-scripts

      - name: ðŸ” Check files
        run: |
          echo "=== Verificando archivos de test ==="
          ls -la src/__tests__/e2e/ || echo "Directorio e2e no encontrado"
          echo ""
          echo "=== Verificando Excel ==="
          ls -la *.xlsx || echo "Sin archivos Excel en root"
          echo ""
          echo "=== Verificando configuraciÃ³n ==="
          ls -la vitest.e2e.config.js || echo "Config E2E no encontrada"

      - name: ðŸ”¥ Setup Firebase Emulator (Optional)
        if: ${{ github.event.inputs.skip_emulator != 'true' }}
        run: |
          npm install -g firebase-tools
          echo "Configurando Firebase Emulator..."
          # No iniciar aÃºn, solo preparar

      - name: ðŸš€ Start Firebase Emulator (Optional)
        if: ${{ github.event.inputs.skip_emulator != 'true' }}
        run: |
          echo "Iniciando Firebase Emulator en background..."
          firebase emulators:start --only firestore --project demo-test &
          echo "Esperando a que el emulator estÃ© listo..."
          sleep 20
          echo "Emulator listo âœ…"

      - name: ðŸ§ª Ejecutar validaciÃ³n E2E
        run: |
          echo "=== Ejecutando tests E2E ==="
          npm run test:e2e:run
        env:
          CI: true
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY || 'test-api-key' }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN || 'test.firebaseapp.com' }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID || 'test-project' }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET || 'test.appspot.com' }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID || '123456789' }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID || 'test-app-id' }}

      - name: ðŸ“Š Generar reporte de validaciÃ³n
        if: success()
        run: |
          echo "# âœ… ValidaciÃ³n E2E Exitosa" > VALIDATION_REPORT.md
          echo "" >> VALIDATION_REPORT.md
          echo "**Fecha:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> VALIDATION_REPORT.md
          echo "**Commit:** ${{ github.sha }}" >> VALIDATION_REPORT.md
          echo "**Branch:** ${{ github.ref_name }}" >> VALIDATION_REPORT.md
          echo "**Triggered by:** ${{ github.event_name }}" >> VALIDATION_REPORT.md
          echo "" >> VALIDATION_REPORT.md
          echo "## ðŸ“‹ Validaciones Completadas" >> VALIDATION_REPORT.md
          echo "" >> VALIDATION_REPORT.md
          echo "- âœ… ImportaciÃ³n de Excel exitosa" >> VALIDATION_REPORT.md
          echo "- âœ… Datos en Firestore validados" >> VALIDATION_REPORT.md
          echo "- âœ… Componentes UI renderizan correctamente" >> VALIDATION_REPORT.md
          echo "- âœ… Capital total coincide en Excel, Firestore y UI" >> VALIDATION_REPORT.md
          echo "- âœ… Todos los bancos del Excel estÃ¡n en Firestore" >> VALIDATION_REPORT.md
          echo "- âœ… Estructura de datos es consistente" >> VALIDATION_REPORT.md
          echo "" >> VALIDATION_REPORT.md
          echo "## ðŸŽ¯ Estado" >> VALIDATION_REPORT.md
          echo "" >> VALIDATION_REPORT.md
          echo "**Estado:** âœ… EXITOSO" >> VALIDATION_REPORT.md
          echo "" >> VALIDATION_REPORT.md
          echo "---" >> VALIDATION_REPORT.md
          echo "" >> VALIDATION_REPORT.md
          echo "_Este reporte fue generado automÃ¡ticamente por el workflow de validaciÃ³n E2E._" >> VALIDATION_REPORT.md

      - name: ðŸ“¤ Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: VALIDATION_REPORT.md
          retention-days: 30

      - name: ðŸ” Check if PR is needed
        id: check_pr
        if: success() && github.event_name == 'schedule'
        run: |
          # Solo crear PR si fue trigger automÃ¡tico (schedule)
          echo "should_create_pr=true" >> $GITHUB_OUTPUT

      - name: ðŸ“ Crear PR si validaciÃ³n exitosa
        if: success() && steps.check_pr.outputs.should_create_pr == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'âœ… ValidaciÃ³n E2E completada exitosamente'
          title: 'âœ… ValidaciÃ³n E2E completada - $(date +%Y-%m-%d)'
          body: |
            ## âœ… ValidaciÃ³n E2E Completada Exitosamente

            Este PR fue generado automÃ¡ticamente despuÃ©s de una validaciÃ³n E2E exitosa.

            ### ðŸ“Š Resultados

            - âœ… **Capital Total:** Excel = Firestore = UI
            - âœ… **Bancos:** Todos los datos del Excel estÃ¡n en Firestore
            - âœ… **UI Components:** RenderizaciÃ³n correcta de KPICards
            - âœ… **Estructura:** Datos consistentes y validados

            ### ðŸ” Detalles

            - **Fecha:** $(date '+%Y-%m-%d %H:%M:%S UTC')
            - **Commit:** ${{ github.sha }}
            - **Workflow:** ${{ github.run_id }}

            ### ðŸ“ Siguiente paso

            Revisar el reporte de validaciÃ³n adjunto en los artifacts del workflow.

            ---
            
            _Este PR fue creado automÃ¡ticamente por el workflow de validaciÃ³n E2E._
          branch: validation/e2e-success-${{ github.run_number }}
          base: main
          labels: |
            automated
            validation
            e2e
          assignees: ${{ github.actor }}

      - name: ðŸ’¬ Comentar en PR si es push
        if: success() && github.event_name == 'push' && github.event.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **ValidaciÃ³n E2E exitosa**\n\nTodos los tests E2E pasaron correctamente. Los datos del Excel se reflejan correctamente en Firestore y en la UI.'
            })

      - name: âŒ Reportar fallo
        if: failure()
        run: |
          echo "# âŒ ValidaciÃ³n E2E Fallida" > VALIDATION_REPORT.md
          echo "" >> VALIDATION_REPORT.md
          echo "**Fecha:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> VALIDATION_REPORT.md
          echo "**Commit:** ${{ github.sha }}" >> VALIDATION_REPORT.md
          echo "**Branch:** ${{ github.ref_name }}" >> VALIDATION_REPORT.md
          echo "" >> VALIDATION_REPORT.md
          echo "## âŒ Error" >> VALIDATION_REPORT.md
          echo "" >> VALIDATION_REPORT.md
          echo "La validaciÃ³n E2E ha fallado. Por favor, revisa los logs del workflow para mÃ¡s detalles." >> VALIDATION_REPORT.md
          echo "" >> VALIDATION_REPORT.md
          echo "**Estado:** âŒ FALLIDO" >> VALIDATION_REPORT.md

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "Limpiando procesos del emulator..."
          pkill -f firebase || true
          echo "Cleanup completado"
