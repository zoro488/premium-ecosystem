name: ðŸ”„ Database Migration & Validation

on:
  workflow_dispatch:
    inputs:
      migration_type:
        description: 'Tipo de migraciÃ³n'
        required: true
        type: choice
        options:
          - schema-update
          - data-migration
          - index-optimization
          - validation-only
        default: 'validation-only'
      dry_run:
        description: 'Modo simulaciÃ³n'
        required: false
        type: boolean
        default: true

  schedule:
    # ValidaciÃ³n diaria de integridad
    - cron: '0 3 * * *'

env:
  NODE_VERSION: '20.x'

jobs:
  validate-schema:
    name: âœ… Validate Database Schema
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: ðŸ” Setup credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=firebase-credentials.json" >> $GITHUB_ENV

      - name: ðŸ“‹ Validate collection schemas
        run: |
          echo "Validating database schemas..."

          # Definir esquemas esperados
          cat > expected-schema.json <<'EOF'
          {
            "usuarios": ["uid", "email", "nombre", "rol", "empresaId", "createdAt"],
            "empresas": ["id", "nombre", "rfc", "plan", "activo", "createdAt"],
            "clientes": ["id", "nombre", "email", "telefono", "empresaId"],
            "ventas": ["id", "clienteId", "monto", "fecha", "status"],
            "bancos": ["id", "nombre", "codigo", "tipo"],
            "cuentas": ["id", "bancoId", "numero", "tipo", "saldo"],
            "tarjetas": ["id", "bancoId", "numero", "limite", "tipo"],
            "transacciones": ["id", "cuentaId", "monto", "tipo", "fecha"]
          }
          EOF

          npm run validate:schema -- --schema=expected-schema.json

      - name: ðŸ” Check for orphaned documents
        run: |
          echo "Checking for orphaned documents..."
          npm run db:check-orphans

      - name: ðŸ” Validate relationships
        run: |
          echo "Validating document relationships..."
          npm run db:validate-relationships

      - name: ðŸ“Š Generate validation report
        run: |
          mkdir -p reports/validation
          npm run db:validation-report -- --output=reports/validation/report.json

      - name: ðŸ“¤ Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: schema-validation-report
          path: reports/validation/

  check-indexes:
    name: ðŸ“‘ Check & Optimize Indexes
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: ðŸ” Setup credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=firebase-credentials.json" >> $GITHUB_ENV

      - name: ðŸ“‘ List current indexes
        run: |
          echo "Listing current Firestore indexes..."
          npm run firestore:list-indexes

      - name: ðŸ” Analyze query patterns
        run: |
          echo "Analyzing query patterns for index suggestions..."
          npm run db:analyze-queries -- --suggest-indexes

      - name: âœ… Validate firestore.indexes.json
        run: |
          if [ -f "firestore.indexes.json" ]; then
            echo "âœ… firestore.indexes.json found"
            cat firestore.indexes.json | jq '.'
          else
            echo "âš ï¸ firestore.indexes.json not found"
          fi

      - name: ðŸ” Check for missing indexes
        run: |
          npm run firestore:check-missing-indexes || echo "âš ï¸ Some queries may need indexes"

  data-integrity:
    name: ðŸ” Data Integrity Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: ðŸ” Setup credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=firebase-credentials.json" >> $GITHUB_ENV

      - name: ðŸ” Check data consistency
        run: |
          echo "Checking data consistency across collections..."
          npm run db:check-consistency

      - name: ðŸ” Validate foreign keys
        run: |
          echo "Validating foreign key relationships..."
          npm run db:validate-foreign-keys

      - name: ðŸ” Check duplicate records
        run: |
          echo "Checking for duplicate records..."
          npm run db:check-duplicates

      - name: ðŸ“Š Generate integrity report
        run: |
          mkdir -p reports/integrity
          npm run db:integrity-report -- --output=reports/integrity/report.json

      - name: ðŸ“¤ Upload integrity report
        uses: actions/upload-artifact@v4
        with:
          name: data-integrity-report
          path: reports/integrity/

  migration-execution:
    name: ðŸ”„ Execute Migration
    runs-on: ubuntu-latest
    needs: [validate-schema, check-indexes, data-integrity]
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.migration_type != 'validation-only'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: ðŸ” Setup credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=firebase-credentials.json" >> $GITHUB_ENV

      - name: ðŸ’¾ Create backup before migration
        run: |
          echo "Creating backup before migration..."
          BACKUP_ID="pre-migration-$(date +%Y%m%d_%H%M%S)"
          npm run db:backup -- --backup-id="$BACKUP_ID"
          echo "BACKUP_ID=$BACKUP_ID" >> $GITHUB_ENV

      - name: ðŸ”„ Execute migration
        run: |
          FLAGS=""
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            FLAGS="$FLAGS --dry-run"
            echo "ðŸ” Running in DRY RUN mode - no changes will be applied"
          fi

          case "${{ github.event.inputs.migration_type }}" in
            schema-update)
              npm run migrate:schema $FLAGS
              ;;
            data-migration)
              npm run migrate:data $FLAGS
              ;;
            index-optimization)
              npm run migrate:indexes $FLAGS
              ;;
          esac

      - name: âœ… Verify migration
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "Verifying migration results..."
          npm run db:verify-migration

      - name: ðŸ“Š Generate migration report
        run: |
          mkdir -p reports/migration

          cat > reports/migration/report.md <<EOF
          # ðŸ”„ Database Migration Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Type:** ${{ github.event.inputs.migration_type }}
          **Dry Run:** ${{ github.event.inputs.dry_run }}
          **Backup ID:** $BACKUP_ID

          ## Summary

          Migration executed successfully.

          ## Next Steps

          1. Verify data integrity
          2. Test application functionality
          3. Monitor for errors
          4. Keep backup for rollback if needed
          EOF

      - name: ðŸ“¤ Upload migration report
        uses: actions/upload-artifact@v4
        with:
          name: migration-report
          path: reports/migration/

  rollback-plan:
    name: ðŸ“‹ Generate Rollback Plan
    runs-on: ubuntu-latest
    needs: migration-execution
    if: always() && needs.migration-execution.result == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“‹ Create rollback instructions
        run: |
          mkdir -p rollback

          cat > rollback/ROLLBACK_INSTRUCTIONS.md <<EOF
          # ðŸ”„ Rollback Instructions

          ## Migration Details

          - **Migration Type:** ${{ github.event.inputs.migration_type }}
          - **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Backup ID:** Check migration report

          ## Rollback Steps

          ### 1. Stop Application
          \`\`\`bash
          # Stop serving traffic
          firebase hosting:disable
          \`\`\`

          ### 2. Restore from Backup
          \`\`\`bash
          npm run db:restore -- --backup-id="BACKUP_ID"
          \`\`\`

          ### 3. Verify Data
          \`\`\`bash
          npm run db:verify
          \`\`\`

          ### 4. Restart Application
          \`\`\`bash
          firebase deploy
          \`\`\`

          ## Verification Checklist

          - [ ] Backup restored successfully
          - [ ] Data integrity verified
          - [ ] Application functionality tested
          - [ ] Users notified of changes
          - [ ] Incident documented

          ## Emergency Contacts

          - DevOps Team: devops@company.com
          - Database Admin: dba@company.com
          EOF

          cat rollback/ROLLBACK_INSTRUCTIONS.md

      - name: ðŸ“¤ Upload rollback plan
        uses: actions/upload-artifact@v4
        with:
          name: rollback-plan
          path: rollback/

  notify-completion:
    name: ðŸ“¢ Notify Completion
    runs-on: ubuntu-latest
    needs: [validate-schema, check-indexes, data-integrity, migration-execution]
    if: always()

    steps:
      - name: ðŸ“Š Summary
        run: |
          echo "ðŸ”„ Database operations completed"
          echo "Schema Validation: ${{ needs.validate-schema.result }}"
          echo "Index Check: ${{ needs.check-indexes.result }}"
          echo "Data Integrity: ${{ needs.data-integrity.result }}"
          echo "Migration: ${{ needs.migration-execution.result }}"

      - name: ðŸ“§ Send notification on failure
        if: |
          needs.validate-schema.result == 'failure' ||
          needs.check-indexes.result == 'failure' ||
          needs.data-integrity.result == 'failure' ||
          needs.migration-execution.result == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: 'ðŸš¨ Database Operation Failed'
          body: |
            âŒ Una operaciÃ³n de base de datos ha fallado.

            Detalles: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Por favor, revisa los reportes inmediatamente.
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: Database Monitor
