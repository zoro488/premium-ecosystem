name: ðŸ§ª Auto Testing

on:
    push:
        branches:
            - main
            - develop
            - "feature/**"
    pull_request:
        branches:
            - main
            - develop
    workflow_dispatch:

jobs:
    test:
        name: Run All Tests
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [18, 20]

        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"

            - name: ðŸ“¥ Install dependencies
              run: npm ci

            - name: ðŸ” Lint check
              run: npm run lint

            - name: ðŸ”§ Type check
              run: npx tsc --noEmit
              continue-on-error: true

            - name: ðŸ§ª Unit tests
              run: npm run test

            - name: ðŸ“Š Test coverage
              run: npm run test:coverage

            - name: ðŸ“¤ Upload coverage
              uses: codecov/codecov-action@v4
              if: matrix.node-version == 20
              with:
                  files: ./coverage/coverage-final.json
                  flags: unittests

            - name: ðŸŽ­ E2E tests
              run: npm run test:e2e
              continue-on-error: true

            - name: ðŸ“Š Test summary
              if: always()
              run: |
                  echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Node version:** ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
